<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karaoke Odası</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #startButton, #stopButton {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    #stopButton {
      background-color: #dc3545;
    }
    #chat {
      margin-top: 20px;
      width: 100%;
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
    }
    #messageBox {
      width: 100%;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>Karaoke Odası</h1>
  <button id="startButton">Mikrofonu Aç</button>
  <button id="stopButton" disabled>Dur</button>
  <audio id="audioPlayer" controls></audio>

  <h3>Sohbet:</h3>
  <div id="chat"></div>
  <input type="text" id="messageBox" placeholder="Mesaj yazın..." />
  <button id="sendMessage">Gönder</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io(); // Socket.io bağlantısı

    let mediaRecorder;
    let audioChunks = [];

    // Mikrofonu açma
    document.getElementById('startButton').addEventListener('click', () => {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then((stream) => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            socket.emit('audio', audioBlob); // Ses verisini sunucuya gönder
            audioChunks = [];
          };

          mediaRecorder.start();
          document.getElementById('stopButton').disabled = false;
          document.getElementById('startButton').disabled = true;
        })
        .catch((err) => {
          console.error('Mikrofon hatası:', err);
        });
    });

    // Mikrofonu durdurma
    document.getElementById('stopButton').addEventListener('click', () => {
      mediaRecorder.stop();
      document.getElementById('stopButton').disabled = true;
      document.getElementById('startButton').disabled = false;
    });

    // Diğer kullanıcılara ses iletme
    socket.on('audio', (audioBlob) => {
      const audio = new Audio(URL.createObjectURL(audioBlob));
      audio.play(); // Gelen ses verisini çal
    });

    // Sohbet mesajlarını gösterme
    socket.on('message', (message) => {
      const chatBox = document.getElementById('chat');
      chatBox.innerHTML += `<p><strong>${message.username}: </strong>${message.text}</p>`;
      chatBox.scrollTop = chatBox.scrollHeight; // Son mesaja kaydır
    });

    // Mesaj gönderme
    document.getElementById('sendMessage').addEventListener('click', () => {
      const messageBox = document.getElementById('messageBox');
      const message = messageBox.value;
      messageBox.value = ''; // Mesaj kutusunu temizle

      // Mesajı sunucuya gönderme
      socket.emit('message', { username: 'Kullanıcı', text: message });
    });
  </script>
</body>
</html>
